<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>Stage 4 – Folder Sort Game (Multi-Falling)</title>
  <style>
    body {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: start;
      justify-content: center;
    }
    .bg {
      width: 1250px;
      height: auto;
      object-fit: contain;
    }
    .emotion-img {
      position: absolute;
      transform: translateX(-94px) translateY(168px);
      width: 255px;
      height: 175px;
      /* background-color: aqua; */
      border-radius: 15px;
      overflow: hidden;
    }
    .emotion-img > img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* ———————————— */
    /* ★ Range Input 스타일링 ★ */
    /* ———————————— */

    .slider-wrap {
      position: absolute;
      left: 50%;
      transform: translateX(-50%) translateY(525px);
      width: 400px;
    }

    .slider-img {
      position: absolute;
      left: 50%;
      transform: translateX(-50%) translateY(500px);
      width: 430px;
      height: auto;
      pointer-events: none;
    }
    .slider-img > img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events: none;
    }

    input[type="range"] {
      width: 100%;
      height: 8px;
      background: transparent;
      border-radius: 4px;
      outline: none;
    }

    /* 실제 드래그 가능한 영역은 작게 유지 */
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 40px;     /* 실제 잡히는 영역 */
      height: 40px;
      background: transparent;
      border: none;
      cursor: pointer;
      position: relative;
    }

    /* 실제 thumb 안에 큰 이미지처럼 보이게 하는 가짜 요소 */
    input[type="range"]::-webkit-slider-thumb::before {
      content: "";
      position: absolute;
      left: 50%;
      top: 50%;
      width: 400px;      /* 시각적으로 보이는 크기 */
      height: 400px;
      transform: translate(-50%, -50%);
      background: url('/assets/button.png') no-repeat center center;
      background-size: contain;
      pointer-events: none;
    }

    /* Firefox용 */
    input[type="range"]::-moz-range-thumb {
      width: 40px;
      height: 40px;
      background: transparent;
      border: none;
      cursor: pointer;
      position: relative;
    }

    input[type="range"]::-moz-range-thumb::before {
      content: "";
      position: absolute;
      left: 50%;
      top: 50%;
      width: 400px;
      height: 400px;
      transform: translate(-50%, -50%);
      background: url('/assets/button.png') no-repeat center center;
      background-size: contain;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <!-- 전체화면 이미지 -->
  <img class="bg" src="/assets/spectrum.png" />

  <!-- 감정 이미지 -->
  <div class="emotion-img">
    <img src="/assets/boomeok.webp" />
  </div>

  <!-- 슬라이더 이미지 -->
  <div class="slider-img">
    <img src="/assets/stick.png" />
  </div>
  <!-- 슬라이더 -->
  <div class="slider-wrap">
    <input id="emotion-range" type="range" min="0" max="100" value="50" />
  </div>

  <script>
    const emotionImgUrls = ['boomeok.webp', 'bug1.avif', 'mint.webp'];
    let idx = 0;

    function reset() {
      const emotionImg = document.querySelector('.emotion-img img');

      // 슬라이더 이동시키기
      const slider = document.getElementById('emotion-range');
      let start = parseInt(slider.value);
      let end = 100;
      let duration = 600; // 0.6초
      let startTime = null;

      function animate(timestamp) {
        if (!startTime) startTime = timestamp;
        const progress = (timestamp - startTime) / duration;

        const value = start + (end - start) * Math.min(progress, 1);
        slider.value = value;

        if (progress < 1) {
          requestAnimationFrame(animate);
        } else {
          // 100% 도달 후: 다음 단계 실행
          idx += 1;
          if (idx > 2) {
            window.location.href = '/index.html';
            return;
          }

          const newUrl = `/assets/${emotionImgUrls[idx]}`;
          emotionImg.src = newUrl;

          // 슬라이더 초기화
          setTimeout(() => {
            slider.value = 50;
            slider.disabled = false;
          }, 300);
        }
      }

      requestAnimationFrame(animate);
    }

    const slider = document.getElementById('emotion-range');
    let releaseTimer = null;

    // 드래그 중에는 아무 동작 없음
    slider.addEventListener('input', () => {
      console.log("dragging:", slider.value);

      // 드래그 중이면 기존 타이머 초기화 (유저가 계속 움직이면 reset 지연됨)
      if (releaseTimer) {
        clearTimeout(releaseTimer);
        releaseTimer = null;
      }
    });

    // 손을 떼는 순간 실행되는 이벤트
    slider.addEventListener('pointerup', () => {
      console.log("released!", idx);

      // 1초 후 reset
      releaseTimer = setTimeout(() => {
        slider.disabled = true;
        reset();

        // reset 후 슬라이더 초기화
        
        slider.value = 50;

        setTimeout(() => {
          slider.disabled = false;
        }, 500);

      }, 1000);
    });
  </script>
</body>
</html>
