<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Uncanny Face – True Default Mode</title>

<style>
:root{
  --bg:#0b0f14;--panel:#0f1621;--border:#203040;
  --text:#e6edf3;
}
body{margin:0;background:var(--bg);color:var(--text);
font-family:system-ui,-apple-system,Segoe UI,Roboto;}
.wrap{display:flex;gap:16px;padding:16px;flex-wrap:wrap;}
.stage{position:relative;width:min(720px,96vw);aspect-ratio:4/3;
border:1px solid var(--border);border-radius:14px;overflow:hidden;}
canvas{position:absolute;inset:0;width:100%;height:100%;}
video{display:none;}
.panel{width:320px;border:1px solid var(--border);
border-radius:14px;padding:12px;background:#0f1621;}
button{width:100%;padding:10px;border-radius:12px;
border:1px solid var(--border);background:#101a27;color:#e6edf3;}
</style>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</head>

<body>
<div class="wrap">
  <div class="stage">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>
  </div>

  <div class="panel">
    <button id="toggleBtn">EDIT MODE</button>
    <p style="font-size:12px;opacity:.7;margin-top:8px">
      시작은 DEFAULT MODE (원본 얼굴)<br/>
      버튼을 눌러야 왜곡이 적용됩니다.
    </p>
  </div>
</div>

<script>
(() => {
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let editMode = false;

const toggleBtn = document.getElementById("toggleBtn");
toggleBtn.onclick = () => {
  editMode = !editMode;
  toggleBtn.textContent = editMode ? "DEFAULT MODE" : "EDIT MODE";
};

function resize(){
  const r = canvas.getBoundingClientRect();
  const dpr = devicePixelRatio || 1;
  canvas.width = r.width * dpr;
  canvas.height = r.height * dpr;
}

function drawFaceline(){
  const cx = canvas.width/2;
  const cy = canvas.height/2;
  ctx.save();
  ctx.setLineDash([10,8]);
  ctx.strokeStyle = "rgba(230,237,243,0.45)";
  ctx.beginPath();
  ctx.ellipse(cx, cy, canvas.width*0.18, canvas.height*0.26, 0, 0, Math.PI*2);
  ctx.stroke();
  ctx.restore();
}

/* DEFAULT MODE RENDER */
function renderDefault(){
  resize();
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  drawFaceline();
}

/* EDIT MODE RENDER (예시: 얼굴 전체 warp 하나만) */
function renderEdit(){
  resize();
  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  // faceline 영역만 살짝 확대
  const cx = canvas.width/2;
  const cy = canvas.height/2;
  const w = canvas.width*0.36;
  const h = canvas.height*0.52;

  ctx.save();
  ctx.translate(cx,cy);
  ctx.beginPath();
  ctx.ellipse(0,0,w/2,h/2,0,0,Math.PI*2);
  ctx.clip();
  ctx.drawImage(
    canvas,
    cx-w/2, cy-h/2, w, h,
    -w*0.55, -h*0.55, w*1.1, h*1.1
  );
  ctx.restore();

  drawFaceline();
}

/* FaceMesh loop */
const faceMesh = new FaceMesh({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`
});
faceMesh.setOptions({maxNumFaces:1});
faceMesh.onResults(() => {
  if(editMode) renderEdit();
  else renderDefault();
});

(async () => {
  const stream = await navigator.mediaDevices.getUserMedia({video:true});
  video.srcObject = stream;
  await video.play();
  const cam = new Camera(video,{
    onFrame:()=>faceMesh.send({image:video})
  });
  cam.start();
})();
})();
</script>
</body>
</html>
